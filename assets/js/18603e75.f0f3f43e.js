"use strict";(self.webpackChunkfeatureflow_docs=self.webpackChunkfeatureflow_docs||[]).push([[6834],{118:(e,t,n)=>{n.d(t,{A:()=>a});const a=n.p+"assets/images/lambda-feature-targeting-us-162e160c66cf295548c00ce8d9031ced.png"},671:(e,t,n)=>{n.d(t,{A:()=>a});const a=n.p+"assets/images/featureflow-select-sdk-key-ab8e596a4f6f9292b1ff9edaf2023dd7.png"},780:(e,t,n)=>{n.d(t,{A:()=>a});const a=n.p+"assets/images/lambda-deploy-1-680cfb3e497c9ab99660a4d34d83c578.png"},1299:(e,t,n)=>{n.d(t,{A:()=>a});const a=n.p+"assets/images/lambda-logs-new-29acee2e57f07a7e684c98047d06238b.png"},1651:(e,t,n)=>{n.d(t,{A:()=>a});const a=n.p+"assets/images/lambda-feature-settings-9316b47d8c34d41a1140d2eddc53ce51.png"},3964:(e,t,n)=>{n.d(t,{A:()=>a});const a=n.p+"assets/images/lambda-logs-original-132a2772dacf7dc8fe3bcaa8b838e2b5.png"},4711:(e,t,n)=>{n.d(t,{A:()=>a});const a=n.p+"assets/images/lambda-deploy-2-c2a063ec4913cdaec89d0db36d2ffde8.png"},4731:(e,t,n)=>{n.d(t,{A:()=>a});const a=n.p+"assets/images/lambda-feature-targeting-2321b3ddab6b2ce18e5920e43beb2797.png"},7261:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>o,default:()=>h,frontMatter:()=>i,metadata:()=>a,toc:()=>d});const a=JSON.parse('{"id":"SDK_Guides/lambda","title":"Using Featureflow with AWS Lambda","description":"Overview","source":"@site/versioned_docs/version-2.0.0/05-SDK_Guides/lambda.mdx","sourceDirName":"05-SDK_Guides","slug":"/using-featureflow-with-aws-lambda","permalink":"/using-featureflow-with-aws-lambda","draft":false,"unlisted":false,"tags":[],"version":"2.0.0","frontMatter":{"title":"Using Featureflow with AWS Lambda","sidebar_label":"AWS Lambda","slug":"/using-featureflow-with-aws-lambda"},"sidebar":"docsSidebar","previous":{"title":"Javascript Client","permalink":"/javascript-client"},"next":{"title":"Node.js SDK","permalink":"/nodejs-sdk"}}');var r=n(4848),s=n(8453);const i={title:"Using Featureflow with AWS Lambda",sidebar_label:"AWS Lambda",slug:"/using-featureflow-with-aws-lambda"},o=void 0,l={},d=[{value:"Overview",id:"overview",level:2},{value:"Prerequisites",id:"prerequisites",level:2},{value:"You will need:",id:"you-will-need",level:4},{value:"Create the lambda",id:"create-the-lambda",level:2},{value:"Deploy the lambda",id:"deploy-the-lambda",level:2},{value:"IAM Role for the lambda",id:"iam-role-for-the-lambda",level:4},{value:"Create the feature flag in featureflow",id:"create-the-feature-flag-in-featureflow",level:2},{value:"Test the lambda",id:"test-the-lambda",level:2},{value:"Trigger from CloudFront",id:"trigger-from-cloudfront",level:2},{value:"Links",id:"links",level:2}];function c(e){const t={a:"a",admonition:"admonition",code:"code",em:"em",h2:"h2",h4:"h4",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(t.h2,{id:"overview",children:"Overview"}),"\n",(0,r.jsx)(t.p,{children:"This guide demonstrates using featureflow in an AWS Lambda serverless function."}),"\n",(0,r.jsx)(t.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,r.jsx)(t.h4,{id:"you-will-need",children:"You will need:"}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsxs)(t.li,{children:["A featureflow account - If you don't have one already, Get your Featureflow account at ",(0,r.jsx)(t.a,{href:"http://www.featureflow.io",children:"featureflow.io"})]}),"\n",(0,r.jsx)(t.li,{children:"An AWS Account"}),"\n",(0,r.jsx)(t.li,{children:"For this example, we will use the serverless framework as a simplified way to deploy the function to AWS"}),"\n",(0,r.jsxs)(t.li,{children:["The example code from ",(0,r.jsx)(t.a,{href:"https://github.com/featureflow/featureflow-lambda-edge-example",children:"github"})]}),"\n"]}),"\n",(0,r.jsxs)(t.p,{children:["See ",(0,r.jsx)(t.a,{href:"https://serverless.com",children:"serverless.com"})," to install the serverless command line"]}),"\n",(0,r.jsxs)(t.p,{children:["Clone the Github example code: ",(0,r.jsx)(t.a,{href:"https://github.com/featureflow/featureflow-lambda-edge-example",children:"https://github.com/featureflow/featureflow-lambda-edge-example"})]}),"\n",(0,r.jsx)(t.h2,{id:"create-the-lambda",children:"Create the lambda"}),"\n",(0,r.jsxs)(t.p,{children:["Clone the example code at ",(0,r.jsx)(t.a,{href:"https://github.com/featureflow/featureflow-lambda-edge-example",children:"https://github.com/featureflow/featureflow-lambda-edge-example"})]}),"\n",(0,r.jsx)(t.p,{children:"Let's have a look at the lambda code."}),"\n",(0,r.jsxs)(t.p,{children:["Firstly, you ",(0,r.jsx)(t.strong,{children:"must"})," instantiate featureflow ",(0,r.jsx)(t.strong,{children:"outside"})," of the handler function."]}),"\n",(0,r.jsxs)(t.admonition,{title:"Instantiating the featureflow client outside of the lambda handler function",type:"caution",children:[(0,r.jsxs)(t.p,{children:["It is imperative that you Instantiate the featureflow client ",(0,r.jsx)(t.strong,{children:"outside"})," of the handler function! Featureflow will run as a singleton for the life of the lambda."]}),(0,r.jsx)(t.p,{children:"When instantiated, featureflow will get the latest feature rules, optimally cache your features while the lambda is hot and update configuration automatically if feature flag values change."}),(0,r.jsx)(t.p,{children:"Instantiating the client inside the handler would cause performance issues and excessive requests as feature rules would get loaded for each handler invocation."})]}),"\n",(0,r.jsx)(t.p,{children:"So the first lines of this function are simply to require the nodejs library and to instantiate featureflow."}),"\n",(0,r.jsxs)(t.p,{children:["Replace ",(0,r.jsx)(t.code,{children:"sdk-srv-env-YOUR-KEY"})," with the Server SDK key from your associated featureflow environment."]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-javascript",children:"'use strict';\nvar Featureflow = require('featureflow-node-sdk');\n\nvar featureflow = new Featureflow.Client({apiKey: 'sdk-srv-env-YOUR-KEY'});\n\nexports.handler = async (event) => {\n"})}),"\n",(0,r.jsx)(t.p,{children:(0,r.jsx)(t.img,{alt:"Copy the Server SDK Key",src:n(671).A+"",title:"Select the Server Environment SDK Key",width:"1295",height:"506"})}),"\n",(0,r.jsx)(t.p,{children:"Next we create our handler and add the featureflow evaluation code."}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-javascript",children:"exports.handler = async (event) => {\n  const request = event.Records[0].cf.request;\n  const headers = request.headers;\n  const country = headers['cloudfront-viewer-country'] ? headers['cloudfront-viewer-country'][0].value : \"US\";\n  const cohort = headers['x-cohort'] ? headers['x-cohort'][0].value : \"none\";\n  console.log(`country: ${country} cohort: ${cohort}`);\n  let user = new Featureflow.UserBuilder(\"exampleuser@featureflow.io\")\n      .withAttribute('country', country)\n      .withAttribute('cohort', cohort)\n      .withAttributes('role', ['USER_ADMIN', 'BETA_CUSTOMER'])\n      .build();\n  await featureflow.waitForReady();\n  let response;\n  const evaluated = featureflow.evaluate('lambda-redirect', user).value();\n  console.log(`Featureflow has evaluated: ${evaluated}`);\n  if (featureflow.evaluate('lambda-redirect', user).is(\"original\")){\n    response = {\n      status: '302',\n      statusDescription: 'Found',\n      headers: {\n        location: [{\n          key: 'Location',\n          value: 'https://featureflow.io'\n        }],\n      },\n    };\n  }else if (featureflow.evaluate('lambda-redirect', user).is(\"new\")){\n    response = {\n      status: '302',\n      statusDescription: 'Found',\n      headers: {\n        location: [{\n          key: 'Location',\n          value: 'https://featureflow.com'\n        }],\n      },\n    };\n  }else{\n    response = {\n      status: '302',\n      statusDescription: 'Found',\n      headers: {\n        location: [{\n          key: 'Location',\n          value: 'https://www.featureflow.io',\n        }],\n      },\n    };\n  }\n  return response;\n};\n"})}),"\n",(0,r.jsx)(t.p,{children:"We've put a bit in here so let's unpack it:"}),"\n",(0,r.jsxs)(t.p,{children:["Firstly, we get some context. From the incoming request we grab one Lambda injected header and one custom header, ",(0,r.jsx)(t.code,{children:"country"})," and ",(0,r.jsx)(t.code,{children:"cohort"}),"."]}),"\n",(0,r.jsx)(t.p,{children:"We will use these values in our feature evaluations."}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-javascript",children:"  const country = headers['cloudfront-viewer-country'] ? headers['cloudfront-viewer-country'][0].value : \"US\";\n  const cohort = headers['x-cohort'] ? headers['x-cohort'][0].value : \"none\";\n"})}),"\n",(0,r.jsx)(t.p,{children:"Then we create a featureflow user context object and set some example attributes, we have added country and cohort, plus an example of an array of roles which in a real implementations could be derived from your IAM:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-javascript",children:"let user = new Featureflow.UserBuilder(\"exampleuser@featureflow.io\")\n      .withAttribute('country', country)\n      .withAttribute('cohort', cohort)\n      .withAttributes('role', ['USER_ADMIN', 'BETA_CUSTOMER'])\n      .build();\n"})}),"\n",(0,r.jsxs)(t.p,{children:["We call the ",(0,r.jsx)(t.code,{children:"await"})," function to ensure that featureflow is ready. This covers for the case of the very first lambda invocation, where the SDK may still be pulling feature configuration from featureflow."]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:"await featureflow.waitForReady();\n"})}),"\n",(0,r.jsx)(t.p,{children:"Then we evaluate the feature"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-javascript",children:"if (featureflow.evaluate('lambda-redirect', user).is(\"original\")){\n    response = {\n      status: '302',\n      statusDescription: 'Found',\n      headers: {\n        location: [{\n          key: 'Location',\n          value: 'https://featureflow.io'\n        }],\n      },\n    };\n  }else if (featureflow.evaluate('lambda-redirect', user).is(\"new\")){\n    response = {\n      status: '302',\n      statusDescription: 'Found',\n      headers: {\n        location: [{\n          key: 'Location',\n          value: 'https://featureflow.com'\n        }],\n      },\n    };\n  }else{\n    response = {\n      status: '302',\n      statusDescription: 'Found',\n      headers: {\n        location: [{\n          key: 'Location',\n          value: 'https://www.featureflow.io',\n        }],\n      },\n    };\n  }\n"})}),"\n",(0,r.jsxs)(t.p,{children:["Here we are checking a feature flag named ",(0,r.jsx)(t.code,{children:"lambda-redirect"})," - given the outcome of the evaluation we redirect the user with a 302."]}),"\n",(0,r.jsx)(t.h2,{id:"deploy-the-lambda",children:"Deploy the lambda"}),"\n",(0,r.jsx)(t.h4,{id:"iam-role-for-the-lambda",children:"IAM Role for the lambda"}),"\n",(0,r.jsxs)(t.p,{children:["The lambda has a very basic IAM role set up that will be created by ",(0,r.jsx)(t.code,{children:"serverless"}),". The role has access to write to CloudWatch logs, and it can be assumed by ",(0,r.jsx)(t.code,{children:"lambda"})," and ",(0,r.jsx)(t.code,{children:"edgelambda"})," services. For production, the logs should be more restrictive than the AWS managed ",(0,r.jsx)(t.code,{children:"AWSLambdaBasicExecutionRole"}),"."]}),"\n",(0,r.jsxs)(t.p,{children:["Set up a profile that has access to create cloudformation templates, access S3 etc. Please check the relevant ",(0,r.jsx)(t.a,{href:"https://serverless.com/framework/docs/providers/aws/guide/credentials/",children:"documentation of serverless"}),"."]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-bash",children:"serverless deploy\n"})}),"\n",(0,r.jsx)(t.h2,{id:"create-the-feature-flag-in-featureflow",children:"Create the feature flag in featureflow"}),"\n",(0,r.jsxs)(t.p,{children:["Create a feature in the featureflow console with a matching key (in this example, ",(0,r.jsx)(t.code,{children:"lambda-redirect"}),")"]}),"\n",(0,r.jsxs)(t.p,{children:["Create two variants, ",(0,r.jsx)(t.code,{children:"original"})," and ",(0,r.jsx)(t.code,{children:"new"})," - we will use these to define the 302 redirects in the lambda"]}),"\n",(0,r.jsx)(t.p,{children:(0,r.jsx)(t.img,{alt:"Featureflow Variants",src:n(1651).A+"",title:"Define featureflow variants",width:"2284",height:"1642"})}),"\n",(0,r.jsx)(t.p,{children:"Then you can target the variants using rules based on the user attributes obtained from the header and cookie values:"}),"\n",(0,r.jsx)(t.p,{children:(0,r.jsx)(t.img,{alt:"Featureflow Targeting",src:n(4731).A+"",title:"Define featureflow targeting rules",width:"2260",height:"1718"})}),"\n",(0,r.jsxs)(t.p,{children:["In the above example, we redirect if the ",(0,r.jsx)(t.code,{children:"date"})," is after a certain date. Date is an attribute we get for free from the featureflow SDK and is the date that the request is made."]}),"\n",(0,r.jsxs)(t.p,{children:["We also target the ",(0,r.jsx)(t.code,{children:"country"})," attribute, which we get from ",(0,r.jsx)(t.code,{children:"cloudfront-viewer-country"})," header."]}),"\n",(0,r.jsx)(t.h2,{id:"test-the-lambda",children:"Test the lambda"}),"\n",(0,r.jsx)(t.p,{children:"In the lambda view click 'test' and create an event, for example:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-json",children:'{\n  "Records": [\n    {\n      "cf": {\n        "config": {\n          "distributionId": "EXAMPLE"\n        },\n        "request": {\n          "uri": "/",\n          "method": "GET",\n          "clientIp": "2001:cdba::3257:9652",\n          "headers": {\n            "cloudfront-viewer-country": [\n              {\n                "key": "UK",\n                "value": "UK"\n              }\n            ],\n            "x-cohort": [\n              {\n                "key": "beta",\n                "value": "beta"\n              }\n            ],\n            "user-agent": [\n              {\n                "key": "User-Agent",\n                "value": "Test Agent"\n              }\n            ],\n            "host": [\n              {\n                "key": "Host",\n                "value": "d123.cf.net"\n              }\n            ],\n            "cookie": [\n              {\n                "key": "Cookie",\n                "value": "SomeCookie=1; AnotherOne=A; X-Experiment-Name=B"\n              }\n            ]\n          }\n        }\n      }\n    }\n  ]\n}\n'})}),"\n",(0,r.jsx)(t.p,{children:"Check the result and note the evaluated variant."}),"\n",(0,r.jsx)(t.p,{children:(0,r.jsx)(t.img,{alt:"Featureflow Variants",src:n(3964).A+"",title:"Feature invocation original result logs",width:"3116",height:"1358"})}),"\n",(0,r.jsxs)(t.p,{children:["Try updating the targeting rules, for example, redirect all ",(0,r.jsx)(t.code,{children:"US"})," requests to the ",(0,r.jsx)(t.code,{children:"new"})," URL:"]}),"\n",(0,r.jsx)(t.p,{children:(0,r.jsx)(t.img,{alt:"Featureflow Targeting US beta",src:n(118).A+"",width:"2254",height:"894"})}),"\n",(0,r.jsx)(t.p,{children:(0,r.jsx)(t.img,{alt:"Featureflow Variants",src:n(1299).A+"",title:"Feature invocation new result logs",width:"3122",height:"1358"})}),"\n",(0,r.jsx)(t.h2,{id:"trigger-from-cloudfront",children:"Trigger from CloudFront"}),"\n",(0,r.jsxs)(t.p,{children:["On the AWS console for Lambda, find the function and click on ",(0,r.jsx)(t.em,{children:"Deploy to Lambda@Edge"}),"."]}),"\n",(0,r.jsxs)(t.p,{children:["On the next screen you will need to select which distribution you are deploying to and on which event, select ",(0,r.jsx)(t.code,{children:"viewer request"})," event."]}),"\n",(0,r.jsxs)(t.p,{children:["Viewer request is evaluated ",(0,r.jsx)(t.em,{children:"before"})," the cache is hit, otherwise the cache would continue to return with the first evaluated variant."]}),"\n",(0,r.jsxs)(t.p,{children:[(0,r.jsx)(t.strong,{children:"Select 'Deploy to Lambda@Edge'"}),"\n",(0,r.jsx)(t.img,{alt:"Deploy first step",src:n(780).A+"",title:"Deploy first step",width:"744",height:"245"})]}),"\n",(0,r.jsxs)(t.p,{children:[(0,r.jsx)(t.strong,{children:"Configure a basic trigger and click deploy"}),"\n",(0,r.jsx)(t.img,{alt:"Deploy second step",src:n(4711).A+"",title:"Deploy second step",width:"1644",height:"1352"})]}),"\n",(0,r.jsx)(t.p,{children:"After the function is deployed make a request to the cloudfront url, you should be redirected to the failover endpoint."}),"\n",(0,r.jsxs)(t.p,{children:["Note that the logs will be written to a region that is close to the CDN edge node that is serving you. For example even though the Lambda is in ",(0,r.jsx)(t.code,{children:"us-east-1"})," it is now deployed throughout the distribution and if you are in France for example the logs of the edge function will be written to the Paris region."]}),"\n",(0,r.jsx)(t.h2,{id:"links",children:"Links"}),"\n",(0,r.jsxs)(t.p,{children:["Github repo: ",(0,r.jsx)(t.a,{href:"https://github.com/featureflow/featureflow-lambda-edge-example",children:"https://github.com/featureflow/featureflow-lambda-edge-example"})]}),"\n",(0,r.jsxs)(t.p,{children:["2-minute video guide: ",(0,r.jsx)(t.a,{href:"https://www.youtube.com/watch?v=VbcLbwJirGo",children:"https://www.youtube.com/watch?v=VbcLbwJirGo"})]})]})}function h(e={}){const{wrapper:t}={...(0,s.R)(),...e.components};return t?(0,r.jsx)(t,{...e,children:(0,r.jsx)(c,{...e})}):c(e)}},8453:(e,t,n)=>{n.d(t,{R:()=>i,x:()=>o});var a=n(6540);const r={},s=a.createContext(r);function i(e){const t=a.useContext(s);return a.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function o(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:i(e.components),a.createElement(s.Provider,{value:t},e.children)}}}]);